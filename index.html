<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Science Box | Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø¹Ù„Ù…ÙŠ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&family=Orbitron:wght@400;700&family=Reem+Kufi:wght@700&display=swap" rel="stylesheet">
    
    <!-- Ù…ÙƒØªØ¨Ø© Supabase Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Firebase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* Ù†ÙØ³ Ø§Ù„ØªØµÙ…ÙŠÙ… ØªÙ…Ø§Ù…Ø§Ù‹ Ù„Ù… ÙŠØªØºÙŠØ± */
        :root { --primary-color: #00f2fe; --secondary-color: #4facfe; --bg-dark: #0f172a; --card-bg: rgba(30, 41, 59, 0.7); --study-color: #f59e0b; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--bg-dark); color: white; overflow-x: hidden; }
        .science-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%); overflow: hidden; }
        .particle { position: absolute; background: rgba(0, 242, 254, 0.2); border-radius: 50%; animation: float 20s infinite linear; }
        @keyframes float { 0% { transform: translateY(0) rotate(0deg); opacity: 0; } 50% { opacity: 0.5; } 100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; } }
        .glass-panel { background: var(--card-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5); }
        .sci-title { font-family: 'Orbitron', sans-serif; text-shadow: 0 0 10px var(--primary-color); }
        .folder-card, .file-card { transition: all 0.3s ease; }
        .folder-card:hover, .file-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 242, 254, 0.2); border-color: var(--primary-color); }
        .spin-click:active { transform: rotate(360deg); transition: transform 0.5s ease; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: var(--secondary-color); border-radius: 4px; }
        .file-checkbox { position: absolute; top: 10px; right: 10px; width: 20px; height: 20px; z-index: 30; cursor: pointer; accent-color: var(--primary-color); transform: scale(1.1); opacity: 0.7; transition: opacity 0.2s; }
        .file-card:hover .file-checkbox, .file-checkbox:checked { opacity: 1; }
        .file-selected { border-color: var(--primary-color) !important; background-color: rgba(0, 242, 254, 0.1) !important; }
        .action-bar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(150%); background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(16px); border: 1px solid var(--primary-color); padding: 12px 24px; border-radius: 50px; display: flex; align-items: center; gap: 15px; z-index: 100; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); width: 90%; max-width: 500px; justify-content: center; }
        .action-bar.active { transform: translateX(-50%) translateY(0); }
        .call-animation { animation: ring 1.5s infinite ease-in-out; }
        @keyframes ring { 0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(74, 222, 128, 0); } 100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); } }
        .reject-animation { animation: ring-red 1.5s infinite ease-in-out; }
        @keyframes ring-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .study-font { font-family: 'Reem Kufi', sans-serif; }
        .timer-circle { transition: stroke-dashoffset 1s linear; transform: rotate(-90deg); transform-origin: 50% 50%; }
        .reaction-bounce { animation: bounce-reaction 2s infinite; }
        @keyframes bounce-reaction { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1) rotate(5deg); } }
        .tomato-bounce { animation: bounce-tomato 1.5s infinite ease-in-out; }
        @keyframes bounce-tomato { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div class="science-bg" id="particles-container"></div>

    <header class="glass-panel sticky top-0 z-50 px-4 py-4 mb-8">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3 cursor-pointer" onclick="app.goHome()">
                <i class="fa-solid fa-atom text-4xl text-cyan-400 fa-spin-slow" style="animation-duration: 10s;"></i>
                <div>
                    <h1 class="text-2xl font-bold sci-title tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500">SCIENCE BOX</h1>
                    <p class="text-xs text-gray-400">Ø¨ÙˆØ§Ø¨ØªÙƒ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©</p>
                </div>
            </div>
            <div class="flex items-center gap-2 flex-wrap justify-center">
                <button onclick="studyApp.triggerCall()" class="text-sm bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-400 hover:to-orange-500 text-white px-4 py-2 rounded-full shadow-lg transition transform hover:scale-105 flex items-center gap-2 border border-amber-400/30">
                    <i class="fa-solid fa-phone-volume animate-pulse"></i> Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø© Ø¨ØªÙ†Ø§Ø¯ÙŠ
                </button>
                <button id="admin-toggle-btn" onclick="app.toggleAdminMode()" class="text-sm bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded-full border border-slate-600 transition">
                    <i class="fa-solid fa-user-shield ml-2"></i> Ø§Ù„Ù…Ø´Ø±Ù
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 flex-grow mb-10 pb-20"> 
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <nav class="flex text-gray-300 text-sm w-full md:w-auto overflow-x-auto whitespace-nowrap">
                <ol class="list-none p-0 inline-flex" id="breadcrumbs"></ol>
            </nav>
            <div class="relative w-full md:w-1/3">
                <input type="text" id="search-input" oninput="app.handleSearch(this.value)" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø­Ø§Ø¶Ø±Ø©ØŒ Ù…Ø§Ø¯Ø©ØŒ Ù…Ù„Ù..." 
                    class="w-full bg-slate-800/80 border border-slate-600 text-white px-4 py-2 pr-10 rounded-lg focus:outline-none focus:border-cyan-400 transition placeholder-gray-500">
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"><i class="fa-solid fa-search text-gray-400"></i></div>
            </div>
        </div>

        <div id="loading-indicator" class="hidden text-center py-10">
            <i class="fa-solid fa-circle-notch fa-spin text-4xl text-cyan-400"></i>
            <p class="text-gray-400 mt-2" id="loading-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase...</p>
        </div>

        <div id="admin-controls" class="hidden glass-panel p-4 rounded-xl mb-8 border-l-4 border-yellow-500">
            <h3 class="font-bold text-yellow-500 mb-3 flex justify-between items-center">
                <span><i class="fa-solid fa-tools ml-2"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
                <span class="text-xs font-normal text-gray-400">ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</span>
            </h3>
            <div class="flex gap-3 flex-wrap items-center">
                <button onclick="app.openModal('import-drive')" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg transition text-sm flex items-center gap-2 border border-yellow-500/50 shadow-lg shadow-yellow-500/20"><i class="fa-brands fa-google-drive"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¬Ø¯ÙŠØ¯</button>
                <div class="w-px h-8 bg-gray-600 mx-2 hidden md:block"></div>
                <button onclick="app.openModal('add-folder')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition text-sm"><i class="fa-solid fa-folder-plus ml-2"></i> Ù…Ø¬Ù„Ø¯ ÙŠØ¯ÙˆÙŠ</button>
                <button onclick="app.openModal('add-file')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition text-sm"><i class="fa-solid fa-file-upload ml-2"></i> Ù…Ù„Ù ÙŠØ¯ÙˆÙŠ</button>
                <div class="w-px h-8 bg-gray-600 mx-2 hidden md:block"></div>
                <button onclick="app.wipeAllData()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition text-sm flex items-center gap-2"><i class="fa-solid fa-skull-crossbones"></i> Ø­Ø°Ù Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</button>
            </div>
            <p class="text-[10px] text-gray-400 mt-2">* Ù„ØªØ­Ø¯ÙŠØ« Ù…Ø¬Ù„Ø¯ Ù…Ø¹ÙŠÙ†ØŒ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« <i class="fa-solid fa-sync text-cyan-400"></i> Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙˆÙ‚ Ø§Ù„Ù…Ø¬Ù„Ø¯.</p>
        </div>

        <div id="content-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
        <div id="empty-state" class="hidden text-center py-20"><i class="fa-solid fa-wind text-6xl text-gray-600 mb-4"></i><p class="text-xl text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ù‡Ù†Ø§ Ø¨Ø¹Ø¯...</p></div>
    </main>

    <div id="selection-bar" class="action-bar">
        <span class="text-white font-bold text-sm whitespace-nowrap" id="selected-count">0 Ù…Ù„Ù Ù…Ø­Ø¯Ø¯</span>
        <div class="h-6 w-px bg-gray-600"></div>
        <button onclick="app.copyLinksForNotebook()" class="flex items-center gap-2 text-white hover:text-cyan-400 transition font-bold text-sm whitespace-nowrap"><i class="fa-solid fa-robot"></i> Ù†Ø³Ø® Ù„Ù€ NotebookLM</button>
        <button onclick="app.clearSelection()" class="text-gray-400 hover:text-red-400 text-sm whitespace-nowrap">Ø¥Ù„ØºØ§Ø¡</button>
    </div>

    <footer class="glass-panel py-6 mt-auto">
        <div class="container mx-auto text-center">
            <p class="text-gray-400 text-sm">ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨ÙˆØ§Ø³Ø·Ø© <span class="text-cyan-400 font-bold mx-1">Sohaib</span> &copy; <span id="year"></span></p>
            <div class="flex justify-center gap-6 mt-3">
                <a href="https://www.facebook.com/sohaibhossam1" target="_blank" class="text-gray-400 hover:text-blue-600 transition transform hover:scale-110 duration-300"><i class="fa-brands fa-facebook text-2xl"></i></a>
                <a href="https://www.linkedin.com/in/sohaib-elsharawy-b26188320/" target="_blank" class="text-gray-400 hover:text-blue-400 transition transform hover:scale-110 duration-300"><i class="fa-brands fa-linkedin text-2xl"></i></a>
            </div>
        </div>
    </footer>

    <!-- Study Modals -->
    <div id="modal-study-call" class="fixed inset-0 bg-black/95 hidden z-[80] flex items-center justify-center backdrop-blur-xl">
        <div class="text-center w-full max-w-md p-6">
            <div class="w-32 h-32 bg-slate-800 rounded-full mx-auto mb-6 flex items-center justify-center border-4 border-slate-700 shadow-2xl relative overflow-hidden"><i class="fa-solid fa-book-open-reader text-6xl text-amber-400"></i><div class="absolute inset-0 bg-amber-500/10 animate-pulse"></div></div>
            <h2 class="text-3xl font-bold text-white mb-2">Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©</h2>
            <p class="text-amber-400 animate-pulse mb-12">Ø¨ØªØªØµÙ„ Ø¨ÙŠÙƒ...</p>
            <div class="flex justify-between items-center px-8">
                <button onclick="studyApp.rejectCall()" class="flex flex-col items-center gap-2 group"><div class="w-16 h-16 bg-red-500 rounded-full flex items-center justify-center shadow-lg shadow-red-500/30 transition transform group-hover:scale-110 reject-animation"><i class="fa-solid fa-phone-slash text-2xl text-white"></i></div><span class="text-sm text-gray-400">ÙƒØ¨Ø± Ø¯Ù…Ø§ØºÙƒ</span></button>
                <button onclick="studyApp.answerCall()" class="flex flex-col items-center gap-2 group"><div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center shadow-lg shadow-green-500/30 transition transform group-hover:scale-110 call-animation"><i class="fa-solid fa-phone text-2xl text-white"></i></div><span class="text-sm text-gray-400">Ø±Ø¯ ÙŠØ§ Ø¨Ø·Ù„</span></button>
            </div>
        </div>
    </div>

    <div id="modal-pomodoro-intro" class="fixed inset-0 bg-black/95 hidden z-[82] flex items-center justify-center backdrop-blur-xl">
        <div class="text-center w-full max-w-md p-6">
            <div class="tomato-bounce mb-6"><div class="text-9xl drop-shadow-2xl">ğŸ…</div></div>
            <h2 class="text-3xl font-bold text-white mb-2 study-font">ØªØ°Ø§ÙƒØ± Ø¨Ù€ Ø¨ÙˆÙ…ÙˆØ¯ÙˆØ±ÙˆØŸ</h2>
            <p class="text-gray-400 mb-8 text-sm">ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ø·Ù…Ø§Ø·Ù… Ù„Ù„ØªØ±ÙƒÙŠØ² Ø§Ù„Ø¹Ø§Ù„ÙŠ ğŸ§ </p>
            <div class="flex justify-center gap-4">
                <button onclick="studyApp.openSetup()" class="px-8 py-3 bg-green-600 hover:bg-green-500 text-white rounded-xl font-bold text-lg shadow-lg transform transition hover:scale-105">Ø£ÙŠÙˆÙ‡ ÙŠÙ„Ø§ Ø¨ÙŠÙ†Ø§</button>
                <button onclick="studyApp.rejectCall()" class="px-8 py-3 bg-slate-700 hover:bg-slate-600 text-gray-300 rounded-xl font-bold text-lg shadow-lg">Ù„Ø§</button>
            </div>
        </div>
    </div>

    <div id="modal-study-setup" class="fixed inset-0 bg-black/90 hidden z-[85] flex items-center justify-center backdrop-blur-md">
        <div class="glass-panel p-8 rounded-2xl w-full max-w-md mx-4 relative border border-amber-500/30">
            <h3 class="text-2xl font-bold text-white mb-6 text-center study-font">Ø¬Ø§Ù‡Ø² ØªÙØ±Ù… Ø§Ù„Ù…Ù†Ù‡Ø¬ØŸ ğŸ”¥</h3>
            <div class="space-y-6">
                <div><label class="block text-sm text-gray-400 mb-2">ÙˆÙ‚Øª Ø§Ù„ØªØ±ÙƒÙŠØ² (Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚)</label><input type="number" id="focus-time" value="25" min="1" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-center text-xl text-amber-400 focus:border-amber-500 outline-none"></div>
                <div><label class="block text-sm text-gray-400 mb-2">ÙˆÙ‚Øª Ø§Ù„Ø±Ø§Ø­Ø© (Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚)</label><input type="number" id="break-time" value="5" min="1" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-center text-xl text-blue-400 focus:border-blue-500 outline-none"></div>
            </div>
            <button onclick="studyApp.startSession()" class="w-full mt-8 bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 text-white py-3 rounded-xl font-bold shadow-lg transition transform hover:scale-105">ÙŠÙ„Ø§ Ø¨ÙŠÙ†Ø§! ğŸš€</button>
            <button onclick="studyApp.endSession()" class="w-full mt-3 text-gray-500 text-sm hover:text-white">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div id="study-overlay" class="fixed inset-0 bg-slate-950 z-[90] hidden flex-col items-center justify-center">
        <div class="absolute inset-0 overflow-hidden opacity-20">
            <div class="absolute top-10 left-10 w-64 h-64 bg-amber-600 rounded-full blur-[100px]"></div>
            <div class="absolute bottom-10 right-10 w-64 h-64 bg-blue-600 rounded-full blur-[100px]"></div>
        </div>
        <div class="relative z-10 text-center w-full max-w-md px-6">
            <div class="mb-8 h-32 flex items-center justify-center reaction-bounce"><span id="study-reaction" class="text-8xl filter drop-shadow-lg">ğŸ¥±</span></div>
            <div class="relative w-64 h-64 mx-auto mb-10">
                <svg class="w-full h-full transform -rotate-90">
                    <circle cx="128" cy="128" r="120" stroke="rgba(255,255,255,0.1)" stroke-width="8" fill="none"></circle>
                    <circle id="timer-progress" cx="128" cy="128" r="120" stroke="#f59e0b" stroke-width="8" fill="none" stroke-dasharray="754" stroke-dashoffset="0" stroke-linecap="round" class="timer-circle"></circle>
                </svg>
                <div class="absolute inset-0 flex flex-col items-center justify-center"><span id="timer-display" class="text-6xl font-bold text-white font-mono tracking-wider">25:00</span><span id="session-status" class="text-amber-400 text-sm mt-2 font-bold uppercase tracking-widest">Focus Mode</span></div>
            </div>
            <div class="glass-panel p-6 rounded-xl mb-8 min-h-[100px] flex items-center justify-center border border-white/10 relative overflow-hidden group">
                <div class="absolute inset-0 bg-gradient-to-r from-amber-500/10 to-transparent opacity-0 group-hover:opacity-100 transition"></div>
                <p id="study-quote" class="text-lg md:text-xl text-gray-200 study-font leading-relaxed transition-all duration-500">"ÙˆØ£Ù† Ù„ÙŠØ³ Ù„Ù„Ø¥Ù†Ø³Ø§Ù† Ø¥Ù„Ø§ Ù…Ø§ Ø³Ø¹Ù‰"</p>
            </div>
            <div class="flex justify-center gap-4">
                <button onclick="studyApp.toggleTimer()" id="timer-btn" class="w-16 h-16 rounded-full bg-white text-slate-900 flex items-center justify-center text-2xl shadow-xl hover:scale-110 transition"><i class="fa-solid fa-pause"></i></button>
                <button onclick="studyApp.endSession()" class="w-16 h-16 rounded-full bg-red-500/20 text-red-500 border border-red-500/50 flex items-center justify-center text-2xl shadow-xl hover:bg-red-500 hover:text-white transition"><i class="fa-solid fa-stop"></i></button>
            </div>
        </div>
    </div>

    <!-- General Modals -->
    <div id="modal-welcome" class="fixed inset-0 bg-black/90 hidden z-[70] flex items-center justify-center backdrop-blur-md">
        <div class="glass-panel p-8 rounded-2xl w-full max-w-lg mx-4 text-center relative border border-cyan-500/30 shadow-2xl shadow-cyan-500/20 transform transition-all scale-100">
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-cyan-500/10 rounded-full blur-3xl"></div>
            <div class="absolute -bottom-10 -left-10 w-32 h-32 bg-blue-500/10 rounded-full blur-3xl"></div>
            <div class="mb-6 relative z-10"><i class="fa-solid fa-hands-praying text-5xl text-cyan-400 mb-4 animate-pulse"></i><h2 class="text-2xl font-bold text-white mb-2 sci-title">Ø±Ø³Ø§Ù„Ø© Ø´ÙƒØ± ÙˆØªÙ‚Ø¯ÙŠØ±</h2><div class="h-1 w-20 bg-gradient-to-r from-cyan-500 to-blue-500 mx-auto rounded-full"></div></div>
            <p class="text-gray-300 text-lg leading-relaxed mb-6 relative z-10">Ù†ØªÙ‚Ø¯Ù… Ø¨Ø®Ø§Ù„Øµ Ø§Ù„Ø´ÙƒØ± ÙˆØ§Ù„Ø§Ù…ØªÙ†Ø§Ù† Ù„ÙƒÙ„ Ù…Ù† Ø³Ø§Ù‡Ù… ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØ¥Ù†Ø¬Ø§Ø² Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø¹Ù„Ù…ÙŠ.<br><br>Ù†Ø±Ø¬Ùˆ Ù…Ù†ÙƒÙ… Ø®Ø§Ù„Øµ Ø§Ù„Ø¯Ø¹Ø§Ø¡ Ù„Ù†Ø§ <span class="text-cyan-400 font-bold">Ø¨Ø§Ù„Ù†Ø¬Ø§Ø­ ÙˆØ§Ù„ØªÙˆÙÙŠÙ‚ ÙˆØ§Ù„Ù‡Ø¯Ø§ÙŠØ©</span> ÙÙŠ Ù…Ø³ÙŠØ±ØªÙ†Ø§ Ø§Ù„Ø¹Ù„Ù…ÙŠØ© ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ©.</p>
            <div class="border-t border-slate-700/50 pt-4 mt-6 relative z-10"><p class="text-[10px] text-gray-500 uppercase tracking-widest mb-2">Ø§Ù„Ù‚Ø§Ø¦Ù…ÙˆÙ† Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹</p><p class="text-xs text-cyan-300 font-mono tracking-wider">ØµÙ‡ÙŠØ¨ØŒ Ø¨Ø§Ø³Ù„ØŒ Ø¹Ù…Ø±ØŒ Ø´Ø±ÙˆÙ‚ØŒ Ø§Ù„Ù‚ÙˆØ§ØµØŒ Ø³Ù„Ù…Ù‰ Ù…Ø¬Ø¯ÙŠØŒ Ø´Ø°Ù‰</p></div>
            <button onclick="app.closeModal('welcome')" class="mt-8 px-8 py-2 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white rounded-full font-bold shadow-lg shadow-cyan-500/20 transition transform hover:scale-105 relative z-10">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØµÙØ­ <i class="fa-solid fa-arrow-left mr-2"></i></button>
        </div>
    </div>

    <div id="modal-custom-alert" class="fixed inset-0 bg-black/95 hidden z-[100] flex items-center justify-center backdrop-blur-md">
        <div class="glass-panel p-8 rounded-2xl w-full max-w-sm mx-4 text-center border border-red-500/50 shadow-[0_0_50px_rgba(239,68,68,0.2)] transform transition-all scale-100 relative">
            <div class="absolute -top-6 left-1/2 transform -translate-x-1/2 w-12 h-12 bg-red-600 rounded-full flex items-center justify-center border-4 border-slate-900 shadow-xl text-2xl" id="alert-icon">ğŸ˜¤</div>
            <h3 class="text-xl font-bold text-white mt-4 mb-2 sci-title">Ø®Ù„ÙŠ Ø¨Ø§Ù„Ùƒ!</h3>
            <p id="alert-message" class="text-gray-300 text-lg leading-relaxed mb-6 font-medium"></p>
            <button onclick="document.getElementById('modal-custom-alert').classList.add('hidden')" class="px-8 py-2 bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-500 hover:to-orange-500 text-white rounded-full font-bold shadow-lg transition transform hover:scale-105">Ø­ØµÙ„ Ø®ÙŠØ±</button>
        </div>
    </div>

    <!-- Modals for Import, Add File, etc. -->
    <div id="modal-import-drive" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="glass-panel p-6 rounded-xl w-full max-w-lg mx-4">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2 text-yellow-400"><i class="fa-brands fa-google-drive"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø´Ø¬Ø±ÙŠ (Ø£ÙˆÙ„ Ù…Ø±Ø©)</h3>
            <div class="space-y-3">
                <div><label class="text-xs text-gray-400 mb-1 block">Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¬Ù„Ø¯</label><input type="text" id="import-drive-link" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white text-sm"></div>
                <div><label class="text-xs text-gray-400 mb-1 block">Google Drive API Key</label><input type="text" id="import-api-key" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white text-sm font-mono"></div>
            </div>
            <div id="import-status" class="mt-4 text-xs text-center hidden min-h-[20px]"></div>
            <div class="flex justify-end gap-2 mt-6 pt-4 border-t border-gray-700">
                <button onclick="app.closeModal('import-drive')" class="px-4 py-2 text-gray-400 hover:text-white text-sm">Ø¥Ù„ØºØ§Ø¡</button>
                <button onclick="app.importFromDrive()" id="btn-do-import" class="px-4 py-2 bg-yellow-600 rounded hover:bg-yellow-700 text-white text-sm flex items-center gap-2"><i class="fa-solid fa-cloud-download-alt"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
            </div>
        </div>
    </div>

    <div id="modal-add-folder" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="glass-panel p-6 rounded-xl w-full max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4">Ø¥Ø¶Ø§ÙØ© Ù…Ø¬Ù„Ø¯ ÙŠØ¯ÙˆÙŠØ§Ù‹</h3>
            <input type="text" id="new-folder-name" class="w-full bg-slate-900 border border-slate-600 rounded p-2 mb-4 text-white">
            <div class="flex justify-end gap-2">
                <button onclick="app.closeModal('add-folder')" class="px-4 py-2 text-gray-400 hover:text-white">Ø¥Ù„ØºØ§Ø¡</button>
                <button onclick="app.createFolder()" class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-700">Ø¥Ù†Ø´Ø§Ø¡</button>
            </div>
        </div>
    </div>

    <div id="modal-add-file" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="glass-panel p-6 rounded-xl w-full max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4">Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ù ÙŠØ¯ÙˆÙŠØ§Ù‹</h3>
            <div class="space-y-3">
                <input type="text" id="new-file-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white">
                <input type="text" id="new-file-link" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø·" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white text-sm">
            </div>
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="app.closeModal('add-file')" class="px-4 py-2 text-gray-400 hover:text-white">Ø¥Ù„ØºØ§Ø¡</button>
                <button onclick="app.createFile()" class="px-4 py-2 bg-green-600 rounded hover:bg-green-700">Ø¥Ø¶Ø§ÙØ©</button>
            </div>
        </div>
    </div>

    <div id="modal-file-action" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="glass-panel p-8 rounded-xl w-full max-w-lg mx-4 text-center relative">
            <i class="fa-solid fa-file-pdf text-6xl text-red-500 mb-4 block mx-auto"></i>
            <h3 id="action-file-name" class="text-2xl font-bold mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-8">
                <a id="btn-preview" target="_blank" class="flex items-center justify-center gap-2 bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-xl transition"><i class="fa-solid fa-eye"></i> Ù…Ø¹Ø§ÙŠÙ†Ø©</a>
                <a id="btn-download" href="#" class="flex items-center justify-center gap-2 bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-400 text-white py-3 rounded-xl transition"><i class="fa-solid fa-download"></i> ØªØ­Ù…ÙŠÙ„</a>
            </div>
            <button onclick="app.closeModal('file-action')" class="mt-6 text-sm text-gray-500 hover:text-white underline">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>
    
    <div id="modal-notebook-guide" class="fixed inset-0 bg-black/80 hidden z-[60] flex items-center justify-center backdrop-blur-sm">
        <div class="glass-panel p-8 rounded-xl w-full max-w-lg mx-4 text-center relative border border-purple-500/30">
            <div class="w-16 h-16 bg-purple-500/20 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fa-solid fa-clipboard-check text-3xl text-purple-400"></i></div>
            <h3 class="text-2xl font-bold mb-2 text-white">ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±ÙˆØ§Ø¨Ø·!</h3>
            <p class="text-gray-300 mb-6">Ù„Ù‚Ø¯ ØªÙ… Ù†Ø³Ø® Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©.</p>
            <div class="bg-slate-900/50 p-4 rounded-lg text-right text-sm text-gray-400 mb-6 space-y-2">
                <p>1. Ø³ÙŠØªÙ… ÙØªØ­ NotebookLM Ø§Ù„Ø¢Ù†.</p>
                <p>2. Ø£Ù†Ø´Ø¦ Ù†ÙˆØªØ© Ø¬Ø¯ÙŠØ¯Ø© (New Notebook).</p>
                <p>3. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© <span class="text-white font-bold">Link</span> Ø£Ùˆ <span class="text-white font-bold">Website</span>.</p>
                <p>4. Ø§Ù„ØµÙ‚ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· (Paste) Ø§Ù„ØªÙŠ Ù†Ø³Ø®ØªÙ‡Ø§ Ù„Ù„ØªÙˆ.</p>
            </div>
            <div class="flex justify-center gap-3">
                <button onclick="app.closeModal('notebook-guide')" class="px-6 py-2 text-gray-400 hover:text-white text-sm">Ø¥ØºÙ„Ø§Ù‚</button>
                <a href="https://notebooklm.google.com/" target="_blank" onclick="app.closeModal('notebook-guide')" class="px-6 py-2 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 text-white rounded-lg font-bold shadow-lg shadow-purple-500/20 text-sm flex items-center gap-2">Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„Ù€ NotebookLM <i class="fa-solid fa-arrow-up-right-from-square"></i></a>
            </div>
        </div>
    </div>

    <!-- Script Section -->
    <script>
        // Supabase Client Setup
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        // !!! Ù‡Ø§Ù…: Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø£Ø¯Ù†Ø§Ù‡ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ ÙÙŠ SUPABASE ÙˆØ¥Ù„Ø§ Ù„Ù† ÙŠØ¹Ù…Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ !!!
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        const supabaseUrl = 'https://ohulcejufnlajlokahly.supabase.co';
        const supabaseKey = 'sb_secret_iHl5t0ieljAJqthjzjnyRQ_Ceudx35N';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        document.getElementById('year').textContent = new Date().getFullYear();

        // Particles
        function createParticles() {
            const container = document.getElementById('particles-container');
            for(let i=0; i<20; i++) {
                const particle = document.createElement('div');
                particle.classList.add('particle');
                const size = Math.random() * 5 + 2;
                particle.style.width = `${size}px`; particle.style.height = `${size}px`;
                particle.style.left = `${Math.random() * 100}%`; particle.style.top = `${Math.random() * 100}%`;
                particle.style.animationDuration = `${Math.random() * 10 + 10}s`;
                particle.style.opacity = Math.random() * 0.5;
                container.appendChild(particle);
            }
        }
        createParticles();

        /* === Study App Logic === */
        const studyApp = {
            timer: null,
            autoQuoteInterval: null,
            timeLeft: 0,
            isPaused: false,
            mode: 'focus',
            duration: { focus: 25 * 60, break: 5 * 60 },
            reactions: ['ğŸ¥±', 'ğŸ˜', 'ğŸ¤¨', 'ğŸ¤”', 'ğŸ˜¤', 'ğŸ’ª', 'ğŸ”¥', 'ğŸ¥³'],
            quotes: ["ÙˆÙØ£ÙÙ† Ù„ÙÙ‘ÙŠÙ’Ø³Ù Ù„ÙÙ„Ù’Ø¥ÙÙ†Ø³ÙØ§Ù†Ù Ø¥ÙÙ„ÙÙ‘Ø§ Ù…ÙØ§ Ø³ÙØ¹ÙÙ‰Ù°", "Ø¹Ø§ÙØ± Ù‡ØªÙˆØµÙ„ .. Ø§Ù„Ø­Ù„Ù… Ù…Ø´ Ø¨Ø¹ÙŠØ¯", "Ø¥ÙÙ†ÙÙ‘ Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ù„ÙØ§ ÙŠÙØ¶ÙÙŠØ¹Ù Ø£ÙØ¬Ù’Ø±Ù Ø§Ù„Ù’Ù…ÙØ­Ù’Ø³ÙÙ†ÙÙŠÙ†Ù", "Ø§Ù„Ø¯Ø­ÙŠØ­ Ù…Ø´ Ø£Ø­Ø³Ù† Ù…Ù†Ùƒ ğŸ˜‰", "Ø§Ø³ØªØ±Ø¬Ù„ ÙƒØ¯Ù‡ ÙˆØ®Ù„Øµ Ø§Ù„Ù„ÙŠ ÙˆØ±Ø§Ùƒ", "ÙØ±Ù‡Ø¯ØªØŸ Ù…Ø¹Ù„Ø´ ÙƒÙ…Ù„ ğŸ”‹", "Ø§Ù„Ù†Ø¬Ø§Ø­ Ø¨ÙŠØ­Ø¨Ùƒ Ø¨Ø³ Ø¨ÙŠØªÙ‚Ù„ Ø¹Ù„ÙŠÙƒ â¤ï¸", "Ø§ØµØ¨Ø± ÙˆØµØ§Ø¨Ø± ÙˆØ±Ø§Ø¨Ø·", "Ù…Ù† Ø¬Ø¯ ÙˆØ¬Ø¯ ÙˆÙ…Ù† Ø²Ø±Ø¹ Ø­ØµØ¯", "Ø°Ø§ÙƒØ± ÙŠØµØ­Ø¨ÙŠ Ù‡ÙŠ Ù…Ø´ Ø§Ø­Ø³Ù† Ù…Ù†Ùƒ Ù„Ù…Ø§ Ø³Ø§Ø¨ØªÙƒ Ø¹Ø´Ø§Ù† Ù…Ø³ØªÙ‚Ø¨Ù„Ù‡Ø§", "Ø³ÙŠØ¨Ùƒ Ù…Ù† Ø§Ù„ØªÙŠÙƒ ØªÙˆÙƒ Ù…Ø´ Ù‡ØªÙ‚ÙˆÙ„Ù‡Ù… ÙƒÙ†Øª Ø¨Ø¹Ù…Ù„ Ø±ÙŠØ¨ÙˆØ³Øª", "Ø°Ø§ÙƒØ± Ù…Ø§Ù‡Ùˆ Ù…Ø´ Ù‡ØªØ¨Ù‚Ù‰ Ù…ØªØ³Ø§Ø¨ ÙˆÙÙ‚ÙŠØ± ÙˆÙƒÙ…Ø§Ù† Ø³Ø§Ù‚Ø·"],

            showAlert: function(msg, icon) {
                document.getElementById('alert-message').textContent = msg;
                document.getElementById('alert-icon').textContent = icon;
                document.getElementById('modal-custom-alert').classList.remove('hidden');
            },
            triggerCall: function() { document.getElementById('modal-study-call').classList.remove('hidden'); },
            answerCall: function() {
                document.getElementById('modal-study-call').classList.add('hidden');
                document.getElementById('modal-pomodoro-intro').classList.remove('hidden');
            },
            openSetup: function() {
                document.getElementById('modal-pomodoro-intro').classList.add('hidden');
                document.getElementById('modal-study-setup').classList.remove('hidden');
            },
            rejectCall: function() {
                document.getElementById('modal-study-call').classList.add('hidden');
                document.getElementById('modal-pomodoro-intro').classList.add('hidden');
                this.showAlert('Ø£Ù†Ø§ Ù†ØµØ­ØªÙƒ ÙˆØ£Ù†Øª Ø¨Ø±Ø§Ø­ØªÙƒ ğŸ¤·â€â™‚ï¸', 'ğŸŒš');
            },
            startSession: function() {
                const fTime = document.getElementById('focus-time').value;
                const bTime = document.getElementById('break-time').value;
                this.duration.focus = fTime * 60;
                this.duration.break = bTime * 60;
                document.getElementById('modal-study-setup').classList.add('hidden');
                document.getElementById('study-overlay').classList.remove('hidden');
                document.getElementById('study-overlay').classList.add('flex');
                document.body.style.overflow = 'hidden'; // Lock scroll
                this.mode = 'focus';
                this.timeLeft = this.duration.focus;
                this.isPaused = false;
                this.runTimer();
                this.updateDisplay();
                this.changeQuote();
                this.autoQuoteInterval = setInterval(() => { this.changeQuote(); }, 10000);
            },
            toggleTimer: function() {
                this.isPaused = !this.isPaused;
                const btn = document.getElementById('timer-btn');
                btn.innerHTML = this.isPaused ? '<i class="fa-solid fa-play"></i>' : '<i class="fa-solid fa-pause"></i>';
                if (this.isPaused) this.showAlert('Ø¨ØªÙˆÙ‚Ù Ù„ÙŠÙ‡ØŸ Ù…ØªØ¨Ù‚Ø§Ø´ ØªØ²Ø¹Ù„ Ø¨Ø¹Ø¯ÙŠÙ† Ù„Ù…Ø§ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ØªØ·Ù„Ø¹! ğŸ˜’', 'ğŸ˜’');
            },
            runTimer: function() {
                clearInterval(this.timer);
                this.timer = setInterval(() => {
                    if(!this.isPaused) {
                        if(this.timeLeft > 0) {
                            this.timeLeft--;
                            this.updateDisplay();
                            const total = this.mode === 'focus' ? this.duration.focus : this.duration.break;
                            const progress = 1 - (this.timeLeft / total);
                            const reactionIndex = Math.floor(progress * (this.reactions.length - 1));
                            document.getElementById('study-reaction').textContent = this.reactions[reactionIndex];
                        } else { this.switchMode(); }
                    }
                }, 1000);
            },
            switchMode: function() {
                clearInterval(this.timer);
                if(this.mode === 'focus') {
                    alert('Ø¹Ø§Ø´ ÙŠØ§ Ø¨Ø·Ù„! ÙˆÙ‚Øª Ø§Ù„Ø±Ø§Ø­Ø© â˜•');
                    this.mode = 'break';
                    this.timeLeft = this.duration.break;
                    document.getElementById('session-status').textContent = 'Break Time â˜•';
                    document.getElementById('session-status').classList.replace('text-amber-400', 'text-blue-400');
                    document.getElementById('timer-progress').setAttribute('stroke', '#60a5fa');
                } else {
                    alert('ÙŠÙ„Ø§ Ù†Ø±Ø¬Ø¹ Ù„Ù„Ø´ØºÙ„ ğŸ’ª');
                    this.mode = 'focus';
                    this.timeLeft = this.duration.focus;
                    document.getElementById('session-status').textContent = 'Focus Mode ğŸ”¥';
                    document.getElementById('session-status').classList.replace('text-blue-400', 'text-amber-400');
                    document.getElementById('timer-progress').setAttribute('stroke', '#f59e0b');
                }
                this.runTimer();
            },
            endSession: function() {
                this.showAlert('Ù‚ÙØ±Øª Ø¨Ø¯Ø±ÙŠ Ù„ÙŠÙ‡ØŸ Ù…ØªØ¨Ù‚Ø§Ø´ ØªØ¹ÙŠØ· Ø¨Ø¹Ø¯ÙŠÙ† Ø¨Ù‚Ù‰! ğŸ˜¤', 'ğŸ˜¤');
                clearInterval(this.timer);
                clearInterval(this.autoQuoteInterval);
                document.getElementById('study-overlay').classList.add('hidden');
                document.getElementById('study-overlay').classList.remove('flex');
                document.getElementById('modal-study-setup').classList.add('hidden');
                document.body.style.overflow = 'auto'; // Unlock scroll
            },
            updateDisplay: function() {
                const m = Math.floor(this.timeLeft / 60);
                const s = this.timeLeft % 60;
                document.getElementById('timer-display').textContent = `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
                const circle = document.getElementById('timer-progress');
                const radius = circle.r.baseVal.value;
                const circumference = radius * 2 * Math.PI;
                const total = this.mode === 'focus' ? this.duration.focus : this.duration.break;
                const offset = circumference - (this.timeLeft / total) * circumference;
                circle.style.strokeDashoffset = offset;
            },
            changeQuote: function() {
                const randomIndex = Math.floor(Math.random() * this.quotes.length);
                const quoteEl = document.getElementById('study-quote');
                quoteEl.style.opacity = '0';
                setTimeout(() => {
                    quoteEl.textContent = `"${this.quotes[randomIndex]}"`;
                    quoteEl.style.opacity = '1';
                }, 500);
            }
        };
        window.studyApp = studyApp;

        /* === Main App Logic === */
        const app = {
            data: [], 
            currentFolderId: null, 
            isAdmin: false, 
            searchQuery: '',
            selectedItems: new Set(),
            
            init: async function() {
                setTimeout(() => { this.openModal('welcome'); }, 1000);
                document.getElementById('loading-indicator').classList.remove('hidden');
                const savedKey = localStorage.getItem('googleDriveApiKey');
                if(savedKey) document.getElementById('import-api-key').value = savedKey;

                history.replaceState({ folderId: null }, '', '');
                window.onpopstate = (event) => {
                    if (event.state) {
                        this.currentFolderId = event.state.folderId;
                        this.searchQuery = ''; this.clearSelection(); 
                        document.getElementById('search-input').value = '';
                        this.render();
                    } else { this.currentFolderId = null; this.render(); }
                };

                // Fetch Data from Supabase
                this.fetchData();

                // Realtime subscription
                supabase.channel('custom-all-channel')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'items' }, (payload) => {
                    console.log('Change received!', payload);
                    this.fetchData();
                })
                .subscribe();
            },

            fetchData: async function() {
                const { data, error } = await supabase.from('items').select('*');
                if (error) {
                    console.error("Error fetching data:", error);
                    alert("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
                } else {
                    this.data = data;
                    document.getElementById('loading-indicator').classList.add('hidden');
                    this.render();
                }
            },

            toggleSelection: function(id) {
                if (this.selectedItems.has(id)) this.selectedItems.delete(id);
                else this.selectedItems.add(id);
                this.render();
            },
            clearSelection: function() { this.selectedItems.clear(); this.render(); },
            updateActionBar: function() {
                const bar = document.getElementById('selection-bar');
                const countEl = document.getElementById('selected-count');
                if (this.selectedItems.size > 0) {
                    bar.classList.add('active'); countEl.textContent = `${this.selectedItems.size} Ù…Ù„Ù Ù…Ø­Ø¯Ø¯`;
                } else { bar.classList.remove('active'); }
            },
            copyLinksForNotebook: function() {
                const links = [];
                this.selectedItems.forEach(id => {
                    const item = this.data.find(i => i.id === id);
                    if (item && item.url) links.push(item.url);
                });
                if (links.length === 0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆØ§Ø¨Ø· ØµØ§Ù„Ø­Ø©");
                const textToCopy = links.join('\n');
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                document.body.appendChild(textArea);
                textArea.select();
                try { document.execCommand('copy'); this.openModal('notebook-guide'); } 
                catch (err) { alert('ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„Ø±ÙˆØ§Ø¨Ø·'); }
                document.body.removeChild(textArea);
            },

            // --- Database Operations ---
            refreshSpecificFolder: async function(folderId, driveId, folderName) {
                if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ­Ø¯ÙŠØ« Ù…Ø¬Ù„Ø¯ "${folderName}"ØŸ`)) return;
                const apiKey = localStorage.getItem('googleDriveApiKey');
                if(!apiKey) return alert("ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ API Key Ø£ÙˆÙ„Ø§Ù‹.");
                
                document.getElementById('loading-text').textContent = `Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ«: ${folderName}...`;
                document.getElementById('loading-indicator').classList.remove('hidden');

                try {
                    // 1. Delete Children (Recursive logic needed for full cleanup, simplified here)
                    const allDescendants = this.getAllDescendants(folderId);
                    const idsToDelete = allDescendants.map(i => i.id);
                    
                    if (idsToDelete.length > 0) {
                        const { error } = await supabase.from('items').delete().in('id', idsToDelete);
                        if (error) throw error;
                    }

                    // 2. Re-import
                    await this.runRecursiveImport(driveId, folderId, apiKey);
                    alert(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ø¬Ù„Ø¯ "${folderName}" Ø¨Ù†Ø¬Ø§Ø­!`);
                } catch (error) {
                    console.error(error); alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message);
                } finally {
                    document.getElementById('loading-indicator').classList.add('hidden');
                    document.getElementById('loading-text').textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";
                }
            },

            getAllDescendants: function(parentId) {
                let descendants = [];
                let children = this.data.filter(item => item.parentId === parentId);
                descendants.push(...children);
                children.forEach(child => {
                    if (child.type === 'folder') descendants.push(...this.getAllDescendants(child.id));
                });
                return descendants;
            },

            importFromDrive: async function() {
                const link = document.getElementById('import-drive-link').value;
                const apiKey = document.getElementById('import-api-key').value;
                const statusEl = document.getElementById('import-status');
                const btn = document.getElementById('btn-do-import');

                if (!link || !apiKey) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");
                let rootFolderId = "";
                const match = link.match(/folders\/([a-zA-Z0-9_-]+)/);
                if (match) rootFolderId = match[1]; else return alert("Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­");

                localStorage.setItem('googleDriveApiKey', apiKey);
                statusEl.classList.remove('hidden');
                btn.disabled = true; btn.classList.add('opacity-50');

                try {
                    await this.runRecursiveImport(rootFolderId, this.currentFolderId, apiKey, (msg) => {
                        statusEl.innerHTML = `<span class="text-yellow-400"><i class="fa-solid fa-spinner fa-spin"></i> ${msg}</span>`;
                    });
                    statusEl.innerHTML = `<span class="text-green-400">ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­!</span>`;
                    setTimeout(() => {
                        this.closeModal('import-drive');
                        document.getElementById('import-drive-link').value = '';
                        statusEl.classList.add('hidden');
                        btn.disabled = false; btn.classList.remove('opacity-50');
                    }, 2000);
                } catch (error) {
                    statusEl.innerHTML = `<span class="text-red-400">Ø®Ø·Ø£: ${error.message}</span>`;
                    btn.disabled = false; btn.classList.remove('opacity-50');
                }
            },

            runRecursiveImport: async function(driveRootId, parentDbId, apiKey, statusCallback) {
                let queue = [{ driveId: driveRootId, parentId: parentDbId }];
                let totalImported = 0;

                while(queue.length > 0) {
                    const current = queue.shift();
                    if(statusCallback) statusCallback(`Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª... (Ø¨Ø§Ù‚ÙŠ ${queue.length})`);
                    let pageToken = null;
                    do {
                        const query = `'${current.driveId}' in parents and trashed = false`;
                        let url = `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&key=${apiKey}&fields=nextPageToken,files(id,name,mimeType,webViewLink)&pageSize=100`;
                        if(pageToken) url += `&pageToken=${pageToken}`;
                        
                        const res = await fetch(url);
                        const result = await res.json();
                        if (result.error) throw new Error(result.error.message);

                        const files = result.files;
                        pageToken = result.nextPageToken;

                        if (files && files.length > 0) {
                            const itemsToInsert = files.map(file => {
                                const isFolder = file.mimeType === 'application/vnd.google-apps.folder';
                                return {
                                    type: isFolder ? 'folder' : 'file',
                                    name: file.name,
                                    url: file.webViewLink,
                                    "parentId": current.parentId, // Note quotes for exact case if column is camelCase
                                    "driveId": file.id
                                };
                            });
                            
                            // Insert into Supabase
                            const { data: insertedItems, error } = await supabase.from('items').insert(itemsToInsert).select();
                            if(error) throw error;
                            
                            // Add subfolders to queue
                            insertedItems.forEach(item => {
                                if (item.type === 'folder') {
                                    // Match driveId from source file list to new DB id
                                    const sourceFile = files.find(f => f.name === item.name && f.webViewLink === item.url); 
                                    // Better to assume order is maintained or rely on name/url unique combo
                                    // A safer approach is inserting one by one or maintaining a map, but for bulk speed:
                                    // We stored driveId in DB, so we can use that.
                                    if(item.driveId) queue.push({ driveId: item.driveId, parentId: item.id });
                                }
                            });
                            totalImported += itemsToInsert.length;
                        }
                    } while (pageToken);
                }
                return totalImported;
            },

            wipeAllData: async function() {
                if(!confirm("âš ï¸ ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠ!")) return;
                const secret = prompt("Ø§ÙƒØªØ¨ 'Ø­Ø°Ù' Ù„Ù„ØªØ£ÙƒÙŠØ¯:");
                if(secret !== "Ø­Ø°Ù") return;
                
                document.getElementById('loading-indicator').classList.remove('hidden');
                // Delete everything where id is not null (basically all rows)
                const { error } = await supabase.from('items').delete().neq('id', '00000000-0000-0000-0000-000000000000'); 
                if(error) alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù");
                else { alert("ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹"); this.goHome(); }
                document.getElementById('loading-indicator').classList.add('hidden');
            },

            convertDriveLink: function(url) {
                let fileId = "";
                if (url.indexOf('id=') > -1) { const match = url.match(/id=([a-zA-Z0-9_-]{25,})/); if(match) fileId = match[1]; } 
                else { const match = url.match(/\/d\/([a-zA-Z0-9_-]{25,})/); if(match) fileId = match[1]; }
                if (!fileId) return { preview: url, download: url };
                return { preview: `https://drive.google.com/file/d/${fileId}/preview`, download: `https://drive.google.com/uc?export=download&id=${fileId}` };
            },

            toggleAdminMode: function() {
                if (!this.isAdmin) {
                    const pass = prompt("ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:");
                    if (pass === "moovx") {
                        this.isAdmin = true;
                        document.getElementById('admin-toggle-btn').classList.replace('bg-slate-800', 'bg-red-600');
                        document.getElementById('admin-controls').classList.remove('hidden');
                        this.render(); 
                    } else alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!");
                } else {
                    this.isAdmin = false;
                    document.getElementById('admin-toggle-btn').classList.replace('bg-red-600', 'bg-slate-800');
                    document.getElementById('admin-controls').classList.add('hidden');
                    this.render(); 
                }
            },

            navigateTo: function(folderId) {
                this.currentFolderId = folderId;
                this.searchQuery = ''; this.clearSelection(); 
                document.getElementById('search-input').value = '';
                history.pushState({ folderId: folderId }, '', '');
                this.render();
            },
            goHome: function() {
                this.currentFolderId = null;
                this.searchQuery = ''; this.clearSelection(); 
                document.getElementById('search-input').value = '';
                history.pushState({ folderId: null }, '', '');
                this.render();
            },
            handleSearch: function(q) { this.searchQuery = q.toLowerCase(); this.render(); },

            render: function() {
                const grid = document.getElementById('content-grid');
                grid.innerHTML = '';
                let itemsToShow = this.searchQuery 
                    ? this.data.filter(i => i.name && i.name.toLowerCase().includes(this.searchQuery))
                    : this.data.filter(i => i.parentId === this.currentFolderId);

                this.renderBreadcrumbs();
                if (itemsToShow.length === 0) document.getElementById('empty-state').classList.remove('hidden');
                else document.getElementById('empty-state').classList.add('hidden');

                itemsToShow.forEach(item => {
                    const el = document.createElement('div');
                    if (item.type === 'folder') {
                        el.className = 'folder-card glass-panel p-6 rounded-xl cursor-pointer flex flex-col items-center justify-center text-center group h-48 relative';
                        el.onclick = (e) => { if(!e.target.closest('button')) this.navigateTo(item.id); };
                        
                        const refreshBtn = (this.isAdmin && item.driveId) ? `<button onclick="app.refreshSpecificFolder('${item.id}', '${item.driveId}', '${item.name}')" title="ØªØ­Ø¯ÙŠØ«" class="absolute top-2 right-2 text-cyan-400 hover:text-white p-2 bg-slate-900/50 hover:bg-cyan-600 rounded-full w-8 h-8 flex items-center justify-center transition hover:rotate-180 z-20 spin-click"><i class="fa-solid fa-sync text-xs"></i></button>` : '';
                        const deleteBtn = this.isAdmin ? `<button onclick="app.deleteItem('${item.id}')" class="delete-btn absolute top-2 left-2 text-red-400 hover:text-red-600 p-2 z-20"><i class="fa-solid fa-trash"></i></button>` : '';

                        el.innerHTML = `${refreshBtn} ${deleteBtn} <div class="w-16 h-16 bg-blue-500/10 rounded-full flex items-center justify-center mb-4 group-hover:bg-blue-500/20 transition"><i class="fa-solid fa-folder text-4xl text-blue-400 group-hover:scale-110 transition"></i></div><h3 class="font-bold text-lg text-gray-100">${item.name}</h3><p class="text-xs text-gray-500 mt-1">${this.countItems(item.id)} Ø¹Ù†ØµØ±</p>`;
                    } else {
                        const isSelected = this.selectedItems.has(item.id);
                        el.className = `file-card glass-panel p-4 rounded-xl cursor-pointer flex items-center gap-4 group relative overflow-hidden transition ${isSelected ? 'file-selected' : ''}`;
                        el.onclick = (e) => { if(!e.target.closest('button') && !e.target.closest('input')) this.handleFileClick(item); };
                        const deleteBtn = this.isAdmin ? `<button onclick="app.deleteItem('${item.id}')" class="delete-btn absolute top-2 left-2 text-red-400 hover:text-red-600 bg-slate-900/50 rounded-full w-8 h-8 flex items-center justify-center z-20"><i class="fa-solid fa-trash text-xs"></i></button>` : '';
                        el.innerHTML = `<input type="checkbox" class="file-checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); app.toggleSelection('${item.id}')"> ${deleteBtn} <div class="absolute left-0 top-0 w-1 h-full bg-red-500"></div><div class="w-12 h-12 bg-red-500/10 rounded-lg flex items-center justify-center shrink-0"><i class="fa-solid fa-file-pdf text-2xl text-red-500"></i></div><div class="flex-grow min-w-0"><h3 class="font-bold text-sm text-gray-200 truncate">${item.name}</h3><p class="text-xs text-gray-500 mt-1">PDF Document</p></div><i class="fa-solid fa-chevron-left text-gray-600 group-hover:text-cyan-400 transition"></i>`;
                    }
                    grid.appendChild(el);
                });
                this.updateActionBar();
            },

            countItems: function(folderId) { return this.data.filter(i => i.parentId === folderId).length; },
            renderBreadcrumbs: function() {
                const bc = document.getElementById('breadcrumbs'); bc.innerHTML = '';
                let homeLi = document.createElement('li');
                homeLi.innerHTML = `<span class="cursor-pointer hover:text-cyan-400 ${this.currentFolderId === null ? 'text-cyan-400 font-bold' : ''}" onclick="app.goHome()"><i class="fa-solid fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>`;
                bc.appendChild(homeLi);
                if (this.currentFolderId) {
                    let path = []; let curr = this.data.find(i => i.id === this.currentFolderId);
                    while(curr) { path.unshift(curr); curr = this.data.find(i => i.id === curr.parentId); }
                    path.forEach((f, idx) => {
                        let sep = document.createElement('li'); sep.className = 'mx-2 text-gray-600'; sep.innerHTML = '<i class="fa-solid fa-chevron-left text-xs"></i>'; bc.appendChild(sep);
                        let li = document.createElement('li'); li.innerHTML = `<span class="cursor-pointer hover:text-cyan-400 ${idx === path.length-1 ? 'text-cyan-400 font-bold' : ''}" onclick="app.navigateTo('${f.id}')">${f.name}</span>`; bc.appendChild(li);
                    });
                }
            },
            handleFileClick: function(file) {
                const links = this.convertDriveLink(file.url);
                document.getElementById('action-file-name').textContent = file.name;
                document.getElementById('btn-preview').href = links.preview;
                document.getElementById('btn-download').href = links.download;
                this.openModal('file-action');
            },
            openModal: function(n) { document.getElementById(`modal-${n}`).classList.remove('hidden'); },
            closeModal: function(n) { document.getElementById(`modal-${n}`).classList.add('hidden'); if(n === 'add-folder') document.getElementById('new-folder-name').value = ''; if(n === 'add-file') { document.getElementById('new-file-name').value = ''; document.getElementById('new-file-link').value = ''; } },
            createFolder: function() {
                const name = document.getElementById('new-folder-name').value;
                if (!name) return alert('Ø§Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…');
                supabase.from('items').insert({ type: 'folder', name: name, "parentId": this.currentFolderId }).then(({error}) => { if(error) alert('Ø®Ø·Ø£'); else this.closeModal('add-folder'); });
            },
            createFile: function() {
                const name = document.getElementById('new-file-name').value;
                const link = document.getElementById('new-file-link').value;
                if (!name || !link) return alert('Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©');
                supabase.from('items').insert({ type: 'file', name: name, url: link, "parentId": this.currentFolderId }).then(({error}) => { if(error) alert('Ø®Ø·Ø£'); else this.closeModal('add-file'); });
            },
            deleteItem: function(id) {
                if(confirm('Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ±ØŸ')) supabase.from('items').delete().eq('id', id).then(({error}) => { if(error) alert('Ø®Ø·Ø£'); });
            }
        };

        window.app = app;
        app.init();
    </script>
</body>
</html>